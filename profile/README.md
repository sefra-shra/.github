<img src='profile/shra_logo.png' align="right" height="140" />

# Southern Hemisphere seabird risk assessment

This repository contains a pair of `R` packages `shraInputsCCSBT` and `shraCCSBT` that provide functions and example scripts for preparation of data and model runs for the CCSBT SEFRA-seabird project. The packages also provide access to the biological inputs for the risk assessment model, including demographic parameters and density maps for the seabird populations. In each case, compilation of the package will create a vignette containing a working example of data preparation for the risk assessment model, and an example model run, using artificial data. The data preparation process can then be repeated on your local machine, using your own data.

## Preliminary setup

We recommend that the following `R` packages be installed directly on your machine, as they are required for the setup instructions provided below, and subsequent installation of each individual package:

      install.packages("rmarkdown", "usethis", "installr", "fs", "remotes", "pins")

## Installing pandoc

A recent version of Pandoc (>= 1.12.3) is required to compile the package vignettes with `rmarkdown`. Pandoc is installed as part of the installation of RStudio, and will be available from within an active RStudio session. Pandoc can also be installed directly, so that it is available for package builds from the command line, or outside of an RStudio session. Whether Pandoc is installed and available for use can be checked from within an R or RStudio session using:

      rmarkdown::pandoc_available(version = "1.12.3")

 which should return `TRUE`. Note that if Pandoc is installed separately, and RStudio is also installed, two Pandoc versions may exist on your machine. This can be checked by calling `rmarkdown::pandoc_version()` and `rmarkdown::find_pandoc()` which may return different results depending on whether they are called from within RStudio. Within R, Pandoc will usually be available from:

 `C:/Users/<user-name>/AppData/Local/Pandoc`
 
 and within RStudio, Pandoc will be available from:
 
 `C:/Program Files/RStudio/resources/app/bin/quarto/bin/tools`
 
 We recommend that the package be installed from the command line, and therefore a separate installation of Pandoc will be necessary. If this has not already been completed then on a Windows machine, it is possible to install Pandoc using:
 
      installr::install.pandoc()
 
 or alternatively to follow the instructions [here](https://pandoc.org/installing.html). This will be required to compile the package vignettes. If it is necessary to add Pandoc to your `PATH` for an R session, or to control which version of Pandoc is to be used, then this can be achieved by directly editing the environment variables on your machine, using `Sys.setenv()`, or by editing your `.Renviron` file to include:

      PATH="C:\Users\<user-name>\AppData\Local\Pandoc;${PATH}"

which will add Pandoc to your `PATH` whenever a new R session is started. Finding and editing your `.Renviron` file is considered in more detail below. To set the `PATH` within a current R session, use:

      Sys.setenv(
        PATH = paste(
          Sys.getenv("PATH"), 
          "C:\\Users\\<user-name>\\AppData\\Local\\Pandoc", 
          sep = ";"
        )
      )

## Access to the package repositories

The packages and their associated data are stored securely on the repository and each user has to be authorised before access is granted. Authorisation is granted to a personal access token (PAT) generated by the user. This PAT is retained by each user on their machine, acting as an automatic authentication device every time the repository is accessed.

In order to obtain access to the repositories:

1. Contact the repository administrators, to be included as a member of the `sefra-shra` organisation. You will then be added as a collaborator to the required repositories, with read access privileges.

1. [Create a fine-grain personal access token (PAT)](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#creating-a-fine-grained-personal-access-token) specifically for the [`sefra-shra/shraInputsCCSBT`](https://github.com/sefra-shra/shraInputsCCSBT.git) and [`sefra-shra/shraCCSBT`](https://github.com/sefra-shra/shraCCSBT.git) repositories, with read-only access to 'Contents' and 'Metadata'.

    When creating the fine-grained personal access token, select `sefra-shra` as the resource owner and choose 'Only select repositories' in the 'Repository access' section. Then select the `sefra-shra/shraInputsCCSBT` and `sefra-shra/shraCCSBT` repositories from the dropdown list. Finally, in the 'Repository' permissions section, select Read-only access for both 'Contents' and 'Metadata'.

    Take a copy of the personal access token immediately after creating it, as the token will be required in the next step.

    Please do not send your PAT to the repository administrators directly. Following creation of a PAT, the administrators will automatically recieve notification via GitHub, and can then provide access approval for that token.

1. Create an environment variable `GITHUB_SHRA_DATA_PAT` defined as your personal access token string. There are different ways to do this. We recommend adding the following line to your `.Renviron` file, which should be located in your `R_USER` (or `HOME`) directory:

       GITHUB_SHRA_DATA_PAT = "github_pat_XXXXX"

    where `"github_pat_XXXXX"` is your personal access token. Ensure that there is no whitespace at the end of the added line, and that the `.Renviron` file ends with an empty line.

    For manual editing of your `.Renviron` file, the location of your `R_USER` directory can be found by calling `Sys.getenv("R_USER")`, or `fs::path_home_r()` from within an `R` session. To view the files in this directory, call `list.files(fs::path_home_r(), all.files = TRUE)`. Alternatively, the `.Renviron` file  can be edited directly within `R` by calling `usethis::edit_r_environ()`. This will open a new window containing your `.Renviron` file. Add the required line to your `.Renviron` file, and close the new window. You must then restart `R` for the changes to take effect.

1. Call `Sys.getenv("GITHUB_SHRA_DATA_PAT")` in a new `R` session to check that your personal access token is returned.

## Package installation

Following the generate of a PAT, and approval of access by the repository administrators, it should be possible to install the `shraInputsCCSBT` and `shraCCSBT` packages on your machine. Please see the installation instructions associated with each package.
